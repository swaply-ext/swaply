<div class="page-container">

  <app-app-navbar></app-app-navbar>

  <main class="main-content">

    @if (showSwap()){
      <section class="interchange-section">
        <h2 class="section-title">Próximo Intercambio</h2>
        <app-next-swap (showSwap)="showSwap.set($event)"></app-next-swap>
      </section>
    }

    <section class="nearby-section">
      <div class="nearby-header">
        <h2 class="section-title">
          @if(hasSearched()) { Resultados de búsqueda } @else { Intercambios Cerca de Ti }
        </h2>
        <div class="nearby-actions">
          <app-skill-search #skillSearch style="width: auto; display: block;"
            (skillSelected)="onSkillSelected($event)"></app-skill-search>
          <app-filter-skills #filterSkills (filterChange)="onFilterSelected($event)"></app-filter-skills>
        </div>
      </div>

      <div *ngIf="isLoadingMatches() && cards().length === 0" class="loading-matches-indicator">
        <div class="spinner-mini"></div>
        <span>Cargando resultados...</span>
      </div>

      <div class="card-grid" *ngIf="!isLoadingMatches() || cards().length > 0">

        <div class="skill-card" *ngFor="let card of cards()" (click)="goToSwap(card)">
          <div class="card-image-wrapper">
             <img *ngIf="card.skillImage" [src]="card.skillImage" [alt]="card.skillName" class="card-image"
                (error)="card.skillImage = undefined">
             <div *ngIf="!card.skillImage" class="card-image-placeholder">
               {{ card.skillIcon || '⚡' }}
             </div>
          </div>

          <div class="card-content clickable-user">
            <div class="card-header-row">



              <div class="card-user-info" [routerLink]="['/user', card.username]" (click)="$event.stopPropagation()"
                [class.premium-user]="card.isPremium">

                <img [src]="card.profilePhotoUrl" [alt]="card.username" class="user-avatar">

                <span>{{ card.username }}</span>
              </div>

              <div class="level-container" [ngClass]="getLevelClass(card.skillLevel)">
                <span class="level-text">{{ getLevelLabel(card.skillLevel) }}</span>
                <div class="level-bars">
                  <div class="bar" [class.active]="(card.skillLevel || 1) >= 1"></div>
                  <div class="bar" [class.active]="(card.skillLevel || 1) >= 2"></div>
                  <div class="bar" [class.active]="(card.skillLevel || 1) >= 3"></div>
                </div>
              </div>

            </div>

            <h3>{{ card.skillName }}</h3>

            <ng-container *ngIf="hasSearched()">
              <div *ngIf="card.isSwapMatch" class="match-status is-match">
                <span class="material-symbols-outlined">bolt</span>
                ¡MATCH!
              </div>
              <div *ngIf="!card.isSwapMatch" class="match-status no-match">
                <span class="material-symbols-outlined">person</span>
                No tiene interés en tus habilidades
              </div>
            </ng-container>

            <div class="card-footer">
              <span class="location" [class.nearby]="card.distance === 'Cerca de ti'">
                <span class="material-symbols-outlined card-icon">location_on</span> {{ card.distance }}km
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="see-more-button" *ngIf="!isLoadingMatches() && cards().length === 0 && hasSearched()">
        <p class="msg-no-results">No se encontraron usuarios con esa habilidad.</p>
      </div>

      <div class="see-more-button" *ngIf="!isLoadingMatches() && !hasSearched() && cards().length === 0">
        <p class="msg-instruction">Añade intereses a tu perfil para ver recomendaciones.</p>
      </div>

      <div class="see-more-button" *ngIf="canLoadMore() && !isLoadingMatches() && cards().length > 0">
        <button class="btn btn-primary" (click)="loadMore()">Ver Más</button>
      </div>

      <div class="loading-more-indicator" *ngIf="isLoadingMatches() && cards().length > 0" style="text-align: center; padding: 20px;">
        <div class="spinner-mini" style="display: inline-block;"></div>
        <span style="margin-left: 10px;">Cargando más...</span>
      </div>

    </section>
  </main>
</div>
